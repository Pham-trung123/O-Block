let generatedCaptcha = "";

function generateCaptcha() {
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789";
  generatedCaptcha = "";
  for (let i = 0; i < 5; i++) {
    generatedCaptcha += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  document.getElementById("captcha").innerText = generatedCaptcha;
  console.log('üîê Captcha:', generatedCaptcha);
}

async function registerUser() {
  const username = document.getElementById("username").value.trim();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  const confirm = document.getElementById("confirm").value.trim();
  const inputCaptcha = document.getElementById("captchaInput").value.trim();

  console.log('üéØ Starting registration...');

  // Validation
  if (!username || !email || !password || !confirm || !inputCaptcha) {
    alert("‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
    return;
  }

  if (password !== confirm) {
    alert("‚ùå M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng kh·ªõp!");
    return;
  }

  if (password.length < 6) {
    alert("‚ùå M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!");
    return;
  }

  if (inputCaptcha !== generatedCaptcha) {
    alert("‚ùå Sai m√£ x√°c th·ª±c! Vui l√≤ng th·ª≠ l·∫°i.");
    generateCaptcha();
    return;
  }

  try {
    console.log('üîÑ Sending request to server...');
    
    const response = await fetch("http://localhost:3000/api/register", {
      method: "POST",
      headers: { 
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        fullname: username,
        email: email,
        password: password,
      }),
    });

    console.log('üì® Response status:', response.status);
    
    const data = await response.json();
    console.log('üì¶ Response data:', data);

    // Hi·ªÉn th·ªã th√¥ng b√°o
    alert(data.message);

    if (data.success) {
      setTimeout(() => {
        window.location.href = "../login/login.html";
      }, 1500);
    }

  } catch (err) {
    console.error('üí• Connection error:', err);
    alert("‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi server! Ki·ªÉm tra console ƒë·ªÉ bi·∫øt chi ti·∫øt.");
  }
}

// Kh·ªüi t·∫°o
window.onload = () => {
  console.log('‚úÖ Page loaded');
  generateCaptcha();
  
  document.getElementById("btnRefresh").addEventListener("click", function(e) {
    e.preventDefault();
    generateCaptcha();
  });

  document.getElementById("btnRegister").addEventListener("click", function(e) {
    e.preventDefault();
    console.log('üìù Register button clicked');
    registerUser();
  });
};