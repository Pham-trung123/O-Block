document.addEventListener('DOMContentLoaded', function() {
  // Kh·ªüi t·∫°o CAPTCHA
  generateCaptcha();
  
  // Th√™m event listener cho form
  document.getElementById('registerForm').addEventListener('submit', function(e) {
    e.preventDefault();
    register();
  });
  
  // Event listener cho n√∫t refresh CAPTCHA
  document.getElementById('refreshCaptcha').addEventListener('click', generateCaptcha);
  
  // Event listeners cho real-time validation
  document.getElementById('username').addEventListener('blur', validateUsername);
  document.getElementById('email').addEventListener('blur', validateEmail);
  document.getElementById('password').addEventListener('input', validatePasswordStrength);
  document.getElementById('password').addEventListener('blur', validatePassword);
  document.getElementById('confirm').addEventListener('blur', validateConfirmPassword);
  document.getElementById('captchaInput').addEventListener('blur', validateCaptcha);
  
  // Event listeners cho toggle password
  document.getElementById('togglePassword').addEventListener('click', function() {
    togglePasswordVisibility('password', 'togglePassword');
  });
  
  document.getElementById('toggleConfirmPassword').addEventListener('click', function() {
    togglePasswordVisibility('confirm', 'toggleConfirmPassword');
  });
});

// H√†m t·∫°o CAPTCHA
function generateCaptcha() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
  let captcha = '';
  for (let i = 0; i < 6; i++) {
    captcha += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  document.getElementById('captcha').textContent = captcha;
  
  // Th√™m hi·ªáu ·ª©ng xoay cho n√∫t refresh
  const refreshBtn = document.getElementById('refreshCaptcha');
  refreshBtn.classList.add('loading');
  setTimeout(() => {
    refreshBtn.classList.remove('loading');
  }, 500);
}

// H√†m toggle hi·ªÉn th·ªã m·∫≠t kh·∫©u
function togglePasswordVisibility(inputId, buttonId) {
  const passwordInput = document.getElementById(inputId);
  const toggleButton = document.getElementById(buttonId);
  const icon = toggleButton.querySelector('i');
  
  if (passwordInput.type === 'password') {
    passwordInput.type = 'text';
    icon.className = 'fas fa-eye-slash';
    toggleButton.classList.add('active');
  } else {
    passwordInput.type = 'password';
    icon.className = 'fas fa-eye';
    toggleButton.classList.remove('active');
  }
}

// H√†m ki·ªÉm tra ƒë·ªô m·∫°nh m·∫≠t kh·∫©u
function validatePasswordStrength() {
  const password = document.getElementById('password').value;
  const strengthFill = document.getElementById('strengthFill');
  const strengthText = document.getElementById('strengthText');
  
  if (!password) {
    strengthFill.className = 'strength-fill';
    strengthText.className = 'strength-text';
    strengthText.textContent = 'ƒê·ªô m·∫°nh m·∫≠t kh·∫©u';
    return;
  }
  
  let strength = 0;
  
  // Ki·ªÉm tra ƒë·ªô d√†i
  if (password.length >= 8) strength += 25;
  
  // Ki·ªÉm tra ch·ªØ hoa
  if (/[A-Z]/.test(password)) strength += 25;
  
  // Ki·ªÉm tra ch·ªØ th∆∞·ªùng
  if (/[a-z]/.test(password)) strength += 25;
  
  // Ki·ªÉm tra s·ªë v√† k√Ω t·ª± ƒë·∫∑c bi·ªát
  if (/[0-9]/.test(password)) strength += 15;
  if (/[^A-Za-z0-9]/.test(password)) strength += 10;
  
  // C·∫≠p nh·∫≠t giao di·ªán
  if (strength < 25) {
    strengthFill.className = 'strength-fill weak';
    strengthText.className = 'strength-text weak';
    strengthText.textContent = 'M·∫≠t kh·∫©u r·∫•t y·∫øu';
  } else if (strength < 50) {
    strengthFill.className = 'strength-fill weak';
    strengthText.className = 'strength-text weak';
    strengthText.textContent = 'M·∫≠t kh·∫©u y·∫øu';
  } else if (strength < 75) {
    strengthFill.className = 'strength-fill medium';
    strengthText.className = 'strength-text medium';
    strengthText.textContent = 'M·∫≠t kh·∫©u trung b√¨nh';
  } else if (strength < 90) {
    strengthFill.className = 'strength-fill strong';
    strengthText.className = 'strength-text strong';
    strengthText.textContent = 'M·∫≠t kh·∫©u m·∫°nh';
  } else {
    strengthFill.className = 'strength-fill very-strong';
    strengthText.className = 'strength-text very-strong';
    strengthText.textContent = 'M·∫≠t kh·∫©u r·∫•t m·∫°nh';
  }
}

// H√†m validate username
function validateUsername() {
  const username = document.getElementById('username').value.trim();
  const errorElement = document.getElementById('usernameError');
  const inputElement = document.getElementById('username');
  
  if (!username) {
    showError(errorElement, inputElement, 'Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p');
    return false;
  }
  
  if (username.length < 3) {
    showError(errorElement, inputElement, 'T√™n ƒëƒÉng nh·∫≠p ph·∫£i c√≥ √≠t nh·∫•t 3 k√Ω t·ª±');
    return false;
  }
  
  if (!/^[a-zA-Z0-9_]+$/.test(username)) {
    showError(errorElement, inputElement, 'T√™n ƒëƒÉng nh·∫≠p ch·ªâ ƒë∆∞·ª£c ch·ª©a ch·ªØ c√°i, s·ªë v√† d·∫•u g·∫°ch d∆∞·ªõi');
    return false;
  }
  
  clearError(errorElement, inputElement);
  return true;
}

// H√†m validate email
function validateEmail() {
  const email = document.getElementById('email').value.trim();
  const errorElement = document.getElementById('emailError');
  const inputElement = document.getElementById('email');
  
  if (!email) {
    showError(errorElement, inputElement, 'Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ email');
    return false;
  }
  
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    showError(errorElement, inputElement, 'ƒê·ªãa ch·ªâ email kh√¥ng h·ª£p l·ªá');
    return false;
  }
  
  clearError(errorElement, inputElement);
  return true;
}

// H√†m validate password
function validatePassword() {
  const password = document.getElementById('password').value;
  const errorElement = document.getElementById('passwordError');
  const inputElement = document.getElementById('password');
  
  if (!password) {
    showError(errorElement, inputElement, 'Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u');
    return false;
  }
  
  if (password.length < 6) {
    showError(errorElement, inputElement, 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±');
    return false;
  }
  
  if (!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(password)) {
    showError(errorElement, inputElement, 'M·∫≠t kh·∫©u ph·∫£i ch·ª©a √≠t nh·∫•t m·ªôt ch·ªØ hoa, m·ªôt ch·ªØ th∆∞·ªùng v√† m·ªôt s·ªë');
    return false;
  }
  
  clearError(errorElement, inputElement);
  return true;
}

// H√†m validate confirm password
function validateConfirmPassword() {
  const password = document.getElementById('password').value;
  const confirm = document.getElementById('confirm').value;
  const errorElement = document.getElementById('confirmError');
  const inputElement = document.getElementById('confirm');
  
  if (!confirm) {
    showError(errorElement, inputElement, 'Vui l√≤ng x√°c nh·∫≠n m·∫≠t kh·∫©u');
    return false;
  }
  
  if (password !== confirm) {
    showError(errorElement, inputElement, 'M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp');
    return false;
  }
  
  clearError(errorElement, inputElement);
  return true;
}

// H√†m validate CAPTCHA
function validateCaptcha() {
  const captchaInput = document.getElementById('captchaInput').value.trim();
  const actualCaptcha = document.getElementById('captcha').textContent;
  const errorElement = document.getElementById('captchaError');
  const inputElement = document.getElementById('captchaInput');
  
  if (!captchaInput) {
    showError(errorElement, inputElement, 'Vui l√≤ng nh·∫≠p m√£ x√°c th·ª±c');
    return false;
  }
  
  if (captchaInput !== actualCaptcha) {
    showError(errorElement, inputElement, 'M√£ x√°c th·ª±c kh√¥ng ch√≠nh x√°c');
    return false;
  }
  
  clearError(errorElement, inputElement);
  return true;
}

// H√†m hi·ªÉn th·ªã l·ªói
function showError(errorElement, inputElement, message) {
  errorElement.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
  inputElement.classList.add('error');
}

// H√†m x√≥a l·ªói
function clearError(errorElement, inputElement) {
  errorElement.textContent = '';
  inputElement.classList.remove('error');
}

// H√†m ƒëƒÉng k√Ω ch√≠nh
function register() {
  // Validate t·∫•t c·∫£ c√°c tr∆∞·ªùng
  const isUsernameValid = validateUsername();
  const isEmailValid = validateEmail();
  const isPasswordValid = validatePassword();
  const isConfirmValid = validateConfirmPassword();
  const isCaptchaValid = validateCaptcha();
  
  if (isUsernameValid && isEmailValid && isPasswordValid && isConfirmValid && isCaptchaValid) {
    // Hi·ªÉn th·ªã loading
    const registerBtn = document.querySelector('.register-btn');
    const originalText = registerBtn.innerHTML;
    registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
    registerBtn.disabled = true;
    
    // Gi·∫£ l·∫≠p g·ª≠i d·ªØ li·ªáu
    setTimeout(() => {
      // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
      showSuccessMessage('üéâ ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ki·ªÉm tra email ƒë·ªÉ x√°c th·ª±c t√†i kho·∫£n.');
      
      // Reset form
      document.getElementById('registerForm').reset();
      generateCaptcha();
      clearAllErrors();
      validatePasswordStrength();
      
      // Kh√¥i ph·ª•c n√∫t ƒëƒÉng k√Ω
      registerBtn.innerHTML = originalText;
      registerBtn.disabled = false;
      
      // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang ƒëƒÉng nh·∫≠p sau 2 gi√¢y
      setTimeout(() => {
        window.location.href = '../login/login.html';
      }, 2000);
      
    }, 2000);
  } else {
    // Cu·ªôn ƒë·∫øn tr∆∞·ªùng ƒë·∫ßu ti√™n b·ªã l·ªói
    const firstError = document.querySelector('.error');
    if (firstError) {
      firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
      firstError.focus();
    }
  }
}

// H√†m x√≥a t·∫•t c·∫£ l·ªói
function clearAllErrors() {
  const errorElements = document.querySelectorAll('.error-message');
  const inputElements = document.querySelectorAll('input');
  
  errorElements.forEach(element => {
    element.textContent = '';
  });
  
  inputElements.forEach(element => {
    element.classList.remove('error');
  });
}

// H√†m hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
function showSuccessMessage(message) {
  const existingAlert = document.querySelector('.alert-message');
  if (existingAlert) {
    existingAlert.remove();
  }
  
  const alert = document.createElement('div');
  alert.className = 'alert-message success';
  alert.innerHTML = `
    <i class="fas fa-check-circle"></i>
    <span>${message}</span>
  `;
  
  document.querySelector('.register-container').insertBefore(alert, document.querySelector('#registerForm'));
  
  // Th√™m CSS cho alert
  if (!document.querySelector('#alert-styles')) {
    const style = document.createElement('style');
    style.id = 'alert-styles';
    style.textContent = `
      .alert-message {
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        animation: slideDown 0.3s ease-out;
        font-size: 0.9rem;
      }
      .alert-message.success {
        background: rgba(76, 201, 240, 0.1);
        color: #22543d;
        border: 1px solid rgba(76, 201, 240, 0.3);
      }
      @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
      }
    `;
    document.head.appendChild(style);
  }
}