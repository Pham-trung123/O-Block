// login.js - S·ª≠a ph·∫ßn ki·ªÉm tra ƒëƒÉng nh·∫≠p
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ Login page loaded');
    
    // T·∫†M TH·ªúI COMMENT ph·∫ßn t·ª± ƒë·ªông chuy·ªÉn h∆∞·ªõng ƒë·ªÉ test
    /*
    const isLoggedIn = localStorage.getItem('isLoggedIn');
    if (isLoggedIn === 'true') {
        console.log('‚ÑπÔ∏è User ƒë√£ ƒëƒÉng nh·∫≠p, chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang ch·ªß...');
        window.location.href = "index.html";
        return;
    }
    */
    
    const loginForm = document.getElementById("loginForm");
    
    if (!loginForm) {
        console.error('‚ùå Kh√¥ng t√¨m th·∫•y form ƒëƒÉng nh·∫≠p');
        return;
    }

    loginForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        console.log('üéØ Form submitted');

        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();

        console.log('üìß Email:', email);
        console.log('üîë Password:', password ? '***' : 'empty');

        if (!email || !password) {
            alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
            return;
        }

        const btn = this.querySelector('button[type="submit"]');
        const originalText = btn.textContent;
        
        try {
            btn.textContent = "ƒêang ƒëƒÉng nh·∫≠p...";
            btn.disabled = true;

            console.log('üîÑ ƒêang g·ª≠i y√™u c·∫ßu ƒë·∫øn server...');

            const response = await fetch("http://localhost:3000/api/login", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json" 
                },
                body: JSON.stringify({ email, password }),
            });

            console.log('üì® Response status:', response.status);
            
            const data = await response.json();
            console.log('üì¶ Response data:', data);

            alert(data.message);

            if (data.success) {
                localStorage.setItem('user', JSON.stringify(data.user));
                localStorage.setItem('isLoggedIn', 'true');
                
                console.log('‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng');
                
                setTimeout(() => {
                    window.location.href = "../index.html";
                }, 1000);
            }

        } catch (err) {
            console.error('üí• L·ªói k·∫øt n·ªëi:', err);
            alert("‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server!");
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    });
});